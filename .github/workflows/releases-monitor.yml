name: ü§ñ Releases Monitor

on:
  schedule:
    - cron: '0 */1 * * *'    # ÊØè 1 Â∞èÊó∂Ê£ÄÊü•‰∏ÄÊ¨°
  workflow_dispatch:         # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check time and set flag
      id: time_check
      run: |
        # Ëé∑ÂèñÂΩìÂâçUTCÊó∂Èó¥ÁöÑÂ∞èÊó∂
        CURRENT_HOUR=$(date -u +%H)
        echo "ÂΩìÂâçUTCÂ∞èÊó∂: $CURRENT_HOUR"
        
        # ÂÆö‰πâÂ±èËîΩÊó∂Èó¥ÊÆµÔºàUTCÊó∂Èó¥ÔºâÔºö15:00-22:30 ÂØπÂ∫î‰∏äÊµ∑Êó∂Èó¥ 23:00-06:30
        if [[ "$CURRENT_HOUR" -ge 15 && "$CURRENT_HOUR" -le 22 ]]; then
          echo "ÂΩìÂâçÂ§Ñ‰∫éÂ±èËîΩÊó∂Èó¥ÊÆµÔºåË∑≥ËøáÊ£ÄÊü•"
          echo "should_skip=true" >> $GITHUB_OUTPUT
        else
          echo "ÂΩìÂâç‰∏çÂú®Â±èËîΩÊó∂Èó¥ÊÆµÔºåÁªßÁª≠Ê£ÄÊü•"
          echo "should_skip=false" >> $GITHUB_OUTPUT
        fi
          
    - name: Ensure repos.json
      if: steps.time_check.outputs.should_skip == 'false' || github.event_name == 'workflow_dispatch'
      id: check
      run: |
        [[ -f repos.json ]] || echo '{}' > repos.json

    - name: Install jq
      run: sudo apt-get -qq update && sudo apt-get -qq install -y jq

    - name: Scan repositories
      if: steps.check.outputs.has_new_release == 'true'
      id: scan
      run: |
        changed=false
        notice=""
        repos=$(jq -r 'keys[]' repos.json)
        for repo in $repos; do
          echo "==> $repo"
          api="https://api.github.com/repos/${repo}/releases/latest"
          json=$(curl -sL "$api" -H "Authorization: Bearer ${{ github.token }}")
          tag=$(jq -r '.tag_name // empty' <<< "$json")
          url=$(jq -r '.html_url // empty' <<< "$json")
          if [[ -z "$tag" ]]; then
            echo "   ‚Ü≥ no releases"; continue
          fi

          last=$(jq -r --arg repo "$repo" '.[$repo] // empty' repos.json)
          if [[ "$tag" != "$last" ]]; then
            echo "   ‚Ü≥ NEW $tag"
            changed=true
            
            # Ëé∑Âèñ release notes
            release_notes=$(jq -r '.body // "ÊöÇÊó†Êõ¥Êñ∞ËØ¥Êòé"' <<< "$json")
            # ÈôêÂà∂ release notes ÈïøÂ∫¶ÔºåÈÅøÂÖçÊ∂àÊÅØËøáÈïø
            if [[ ${#release_notes} -gt 500 ]]; then
              release_notes="${release_notes:0:500}..."
            fi
            
            notice+="üì¢ ${repo} ÂèëÂ∏ÉÊñ∞ÁâàÊú¨Ôºö${tag}\n\n"
            notice+="üëâ ${url}\n\n"
            notice+="üìù Êõ¥Êñ∞ËØ¥ÊòéÔºö\n${release_notes}\n\n\n"
            
            tmp=$(mktemp)
            jq --arg repo "$repo" --arg tag "$tag" '.[$repo]=$tag' repos.json > "$tmp" && mv "$tmp" repos.json
          else
            echo "   ‚Ü≥ up-to-date ($tag)"
          fi
        done
        echo -e "$notice" > notice.txt
        echo "changed=$changed" >> $GITHUB_OUTPUT
        
    - name: Send WeCom Notification
      if: steps.scan.outputs.changed == 'true'
      env:
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}    
      run: |
          # ‰ºÅ‰∏öÂæÆ‰ø°Êú∫Âô®‰∫∫Êé®ÈÄÅ
          MESSAGE=$(cat notice.txt)
          curl -X POST "$WECOM_WEBHOOK_UR" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "$MESSAGE"
              }
            }'
            
    - name: Send Gotify Notification
      if: steps.scan.outputs.changed == 'true'
      env:
        GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
      run: |
        # Gotify Êé®ÈÄÅ
        MESSAGE=$(cat notice.txt)
        if [ ! -z "$GOTIFY_URL" ] && [ ! -z "$GOTIFY_TOKEN" ]; then
          curl "$GOTIFY_URL/message?token=$GOTIFY_TOKEN" \
            -F "title=üéØ Release Update"  \
            -F "message=$MESSAGE"  \
            -F "priority=5" \
           || echo "‚ùå Failed to send Telegram notification."
        else
          echo "‚ö†Ô∏è No configuration Telegram parameters, skip notifications."
        fi
    - name: Commit new state
      if: steps.scan.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add repos.json
        git commit -m "bot: update release state"
        git push
