name: ğŸ¤– Releases Monitor

on:
  schedule:
    - cron: '0 */1 * * *'    # æ¯ 1 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check time and set flag
      id: time_check
      run: |
        # è·å–å½“å‰UTCæ—¶é—´çš„å°æ—¶
        CURRENT_HOUR=$(date -u +%H)
        echo "å½“å‰UTCå°æ—¶: $CURRENT_HOUR"
        
        # å®šä¹‰å±è”½æ—¶é—´æ®µï¼ˆUTCæ—¶é—´ï¼‰ï¼š15:00-22:30 å¯¹åº”ä¸Šæµ·æ—¶é—´ 23:00-06:30
        if [[ "$CURRENT_HOUR" -ge 15 && "$CURRENT_HOUR" -le 22 ]]; then
          echo "å½“å‰å¤„äºå±è”½æ—¶é—´æ®µï¼Œè·³è¿‡æ£€æŸ¥"
          echo "should_skip=true" >> $GITHUB_OUTPUT
        else
          echo "å½“å‰ä¸åœ¨å±è”½æ—¶é—´æ®µï¼Œç»§ç»­æ£€æŸ¥"
          echo "should_skip=false" >> $GITHUB_OUTPUT
        fi
          
    - name: Ensure repos.json
      if: steps.time_check.outputs.should_skip == 'false' || github.event_name == 'workflow_dispatch'
      id: check
      run: |
        if [[ ! -f repos.json ]]; then
          echo '{}' > repos.json
          echo "åˆ›å»ºç©ºçš„ repos.json æ–‡ä»¶"
        else
          echo "repos.json å·²å­˜åœ¨"
        fi

    - name: Install jq
      if: steps.time_check.outputs.should_skip == 'false' || github.event_name == 'workflow_dispatch'
      # åŒæ—¶å®‰è£… curl å’Œ jq
      run: sudo apt-get -qq update && sudo apt-get -qq install -y jq curl

    - name: Initialize repository list
      if: steps.time_check.outputs.should_skip == 'false' || github.event_name == 'workflow_dispatch'
      id: init_repos
      # [ä¿®æ”¹ç‚¹3] æ–°å¢æ­¥éª¤ï¼šåˆå§‹åŒ–ä»“åº“åˆ—è¡¨
      run: |
        # å®šä¹‰è¦ç›‘æ§çš„ä»“åº“åˆ—è¡¨
        repos=(
          "cloudreve/Cloudreve"
        )
        
        # è¯»å–ç°æœ‰çš„ repos.json
        current_json=$(cat repos.json)
        
        # æ·»åŠ ç¼ºå¤±çš„ä»“åº“
        for repo in "${repos[@]}"; do
          if ! jq -e "has(\"$repo\")" <<< "$current_json" > /dev/null; then
            echo "æ·»åŠ æ–°ä»“åº“: $repo"
            current_json=$(jq --arg repo "$repo" '.[$repo]=""' <<< "$current_json")
          fi
        done
        
        # ä¿å­˜æ›´æ–°åçš„ repos.json
        echo "$current_json" > repos.json
        echo "å·²åˆå§‹åŒ–ä»“åº“åˆ—è¡¨"
        
    - name: Scan repositories
      if: steps.time_check.outputs.should_skip == 'false' || github.event_name == 'workflow_dispatch'
      id: scan
      run: |
        changed=false
        notice=""
        repos=$(jq -r 'keys[]' repos.json)
        for repo in $repos; do
          echo "==> $repo"
          api="https://api.github.com/repos/${repo}/releases/latest"
          headers=()
          if [[ -n "${{ github.token }}" ]]; then
            headers=(-H "Authorization: Bearer ${{ github.token }}")
          fi
          json=$(curl -sL "${headers[@]}" "$api")
          tag=$(jq -r '.tag_name // empty' <<< "$json")
          url=$(jq -r '.html_url // empty' <<< "$json")
          if [[ -z "$tag" ]]; then
            echo "   â†³ no releases"; continue
          fi

          last=$(jq -r --arg repo "$repo" '.[$repo] // empty' repos.json)
          if [[ "$tag" != "$last" ]]; then
            echo "   â†³ NEW $tag"
            changed=true
            
            release_notes=$(jq -r '.body // "æš‚æ— æ›´æ–°è¯´æ˜"' <<< "$json")
            # æ¸…ç† release notes ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            release_notes=$(echo "$release_notes" | tr -d '\000-\031' | head -c 1000)
            
            notice+="ğŸ“¢ ${repo} å‘å¸ƒæ–°ç‰ˆæœ¬ï¼š${tag}\n\n"
            notice+="ğŸ‘‰ ${url}\n\n"
            notice+="ğŸ“ æ›´æ–°è¯´æ˜ï¼š\n${release_notes}\n\n\n"
            
            tmp=$(mktemp)
            jq --arg repo "$repo" --arg tag "$tag" '.[$repo]=$tag' repos.json > "$tmp" && mv "$tmp" repos.json
          else
            echo "   â†³ up-to-date ($tag)"
          fi
        done
        echo -e "$notice" > notice.txt
        echo "changed=$changed" >> $GITHUB_OUTPUT
        
    - name: Send WeCom Notification
      if: steps.scan.outputs.changed == 'true'
      env:
        WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}    
      run: |
          # ä¼ä¸šå¾®ä¿¡æœºå™¨äººæ¨é€
          MESSAGE=$(cat notice.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          if [ ! -z "$GOTIFY_URL" ] && [ ! -z "$GOTIFY_TOKEN" ]; then
            # æ„å»ºJSONæ•°æ®
            JSON_DATA="{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"content\": \"$MESSAGE\"
              }
            }"
            # å‘é€è¯·æ±‚
            curl -X POST "$WECOM_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$JSON_DATA" \
              -w "\nHTTPçŠ¶æ€ç : %{http_code}\n" \
            || echo "âŒ ä¼ä¸šå¾®ä¿¡å‘é€å¤±è´¥."
          else
            echo "âš ï¸ æ²¡æœ‰ä¼ä¸šå¾®ä¿¡é…ç½®."
          fi
  
    - name: Send Gotify Notification
      if: steps.scan.outputs.changed == 'true'
      env:
        GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
      run: |
        # Gotifyæ¨é€
        MESSAGE=$(cat notice.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        if [ ! -z "$GOTIFY_URL" ] && [ ! -z "$GOTIFY_TOKEN" ]; then
          curl "$GOTIFY_URL/message?token=$GOTIFY_TOKEN" \
            -F "title=ğŸ¯ Release Update"  \
            -F "message=$MESSAGE"  \
            -F "priority=5" \
           || echo "âŒ GOTIFYå‘é€å¤±è´¥."
        else
          echo "âš ï¸ æ²¡æœ‰GOTIFYé…ç½®."
        fi
    - name: Commit new state
      if: steps.scan.outputs.changed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add repos.json
        git diff --staged --quiet || git commit -m "bot: update release state"
        git push
